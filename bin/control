#!/bin/bash

source $OPENSHIFT_CARTRIDGE_SDK_BASH
. ~/.profile

readonly PLAY2_RUNTIME=${OPENSHIFT_DATA_DIR}
readonly PLAY2_PID_RUN=${PLAY2_RUNTIME}/play2.pid
readonly PLAY2_PID_ACTIVATOR_BUILD=${PLAY2_RUNTIME}/play2_activator_build.pid
readonly PLAY2_NUM_BUILD=${PLAY2_RUNTIME}/play2_num_build.counter
readonly PLAY2_DEPLOY_PATH=$OPENSHIFT_DATA_DIR/deploy
readonly CARTRIDGE_TYPE="play2"
readonly WAIT_MESSAGE="So... keep calm and wait... it could be taken ~10 minutes for first build... take a break: watch some videos, listen some music tracks, ..."

function get_num_build {
  if [ -f "$PLAY2_NUM_BUILD" ]; then
    return $(cat $PLAY2_NUM_BUILD)
  else
    echo 0 > $PLAY2_NUM_BUILD
    return 0
  fi
}

function inc_num_build {
  if [ -f "$PLAY2_NUM_BUILD" ]; then
    local INB_NUM_BUILD=$(cat $PLAY2_NUM_BUILD)
    INB_NUM_BUILD=$((INB_NUM_BUILD+1))
    echo $INB_NUM_BUILD > $PLAY2_NUM_BUILD
  else
    echo 1 > $PLAY2_NUM_BUILD
  fi
}

function start {
  # Check for running app
  if is_running $PLAY2_PID_RUN ; then
      echo "Application is already running"
  elif is_running $PLAY2_PID_ACTIVATOR_BUILD ; then
      echo "Application is building"
  elif [ -f "$PLAY2_APPLICATION_PATH" ]; then
    S_BASENAME_FILE=$(basename "$PLAY2_APPLICATION_PATH")
    S_EXTENSION="${S_BASENAME_FILE##*.}"
    if [ $S_EXTENSION != "zip" ]; then
      start_dist "$PLAY2_APPLICATION_PATH"
    else
      echo "Play2 application path is not a zip file, please check PLAY2_APPLICATION_PATH in ~/.profile file"
      exit 2
    fi
  elif [ -d "$PLAY2_APPLICATION_PATH" ]; then
    get_num_build
    local S_NUM_BUILD=$?
    build
    if [ $S_NUM_BUILD -eq 1 ]; then
      # build on first time
      echo "Application first start, waiting build process"
    else
      cd $PLAY2_APPLICATION_PATH
      local S_DIST_FILE=$(find `pwd`/target/universal -name *.zip)
      start_dist "$S_DIST_FILE"
    fi
  fi
}

function start_dist {
  local D_DIST_FILE=$1
  if [ -f "$D_DIST_FILE" ]; then
    local D_BASENAME_FILE=$(basename "$D_DIST_FILE")
    local D_DIST_UNZIPPED="$PLAY2_DEPLOY_PATH/${D_BASENAME_FILE%.*}"
    rm -fR $D_DIST_UNZIPPED
    unzip "$D_DIST_FILE" -d "$PLAY2_DEPLOY_PATH"
    local D_BIN_NAME=$(find $D_DIST_UNZIPPED/bin -type f | grep -v '.bat' | head -n 1)
    local D_PLAY_CRYPTO_SECRET=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9_?' | head -c30)
    local D_APPLICATION_CONF=$(find $D_DIST_UNZIPPED -type f -name application.conf | head -n 1)
    local D_RESOURCE_CONF=$(find $D_DIST_UNZIPPED -type f -name openshift.conf | head -n 1)
    nohup $D_BIN_NAME -Duser.home=${OPENSHIFT_DATA_DIR} -Dhttp.port=8080 -Dhttp.address=${OPENSHIFT_PLAY2_IP} -Dconfig.file=${D_APPLICATION_CONF} -Dconfig.resource=${D_RESOURCE_CONF} -Dplay.crypto.secret="$D_PLAY_CRYPTO_SECRET" -Dpidfile.path=${PLAY2_PID_RUN} -DapplyEvolutions.default=true >> $OPENSHIFT_PLAY2_LOG_DIR/play.log 2>&1 &
  else
    echo "ERROR: Deploy - Dist file [$D_DIST_FILE] not found"
  fi
}


function stop {
  if is_running $PLAY2_PID_RUN ; then
    if [ -f "$PLAY2_PID_RUN" ]; then
      local S_PLAY2_PID=$(cat $PLAY2_PID_RUN);
      echo "Sending SIGTERM to $CARTRIDGE_TYPE:$S_PLAY2_PID ..." 1>&2
      kill_tree $S_PLAY2_PID
    else
      echo "Failed to locate $CARTRIDGE_TYPE PID File" 1>&2
    fi
  else
    echo "$CARTRIDGE_TYPE cart is already stopped"
  fi
}

function restart {
    echo "Restarting $CARTRIDGE_TYPE cart"
    stop
    start
}

function build {
  # Workaround for failure in npm install when a package in package.json
  # points to a git commit.
  # This issue occurs because we are running in the context of a
  # git post receive-hook
  unset GIT_DIR
  unset GIT_WORK_TREE
  if [ -f "$PLAY2_APPLICATION_PATH" ]; then
    echo "Application path is a file, build process skipped"
  elif [ -d "$PLAY2_APPLICATION_PATH" ]; then
    cd ${PLAY2_APPLICATION_PATH}
    get_num_build
    local B_NUM_BUILD=$?
    if is_running $PLAY2_PID_ACTIVATOR_BUILD; then
      echo "Another build process is running, please wait"
    elif [ $B_NUM_BUILD -eq 0 ]; then
      # First build
      echo "First build takes a while."
      echo "At the end of build it will run start process"
      echo "$WAIT_MESSAGE"
      inc_num_build
      # Run gear start in nohup in order
      # to create openshift server correctly.
      # Note: gear start run build function.
      nohup gear start &
    else
      echo "Starting Play activator build process"
      # Clear PID process
      activator clean dist -Duser.home=${OPENSHIFT_DATA_DIR} &
      local B_BUILD_PID=$!
      echo "$B_BUILD_PID" > $PLAY2_PID_ACTIVATOR_BUILD
      inc_num_build
      wait
    fi
  else
    echo "Play2 application path is not a zip file, please check PLAY2_APPLICATION_PATH in ~/.profile file"
    exit 2
  fi
}

function tidy {
  shopt -s dotglob
  rm -rf $OPENSHIFT_TMP_DIR/*
}

# Check if the play2 process is running
function is_running() {
  # Check for running app
  if [ -f "$1" ]; then
    local IR_PID_TO_CHECK=$(cat $1)
    if /bin/ps --pid $IR_PID_TO_CHECK 1>&2 >/dev/null; then
      return 0
    fi
  fi
  return 1
}

function status() {
  if is_running $PLAY2_PID_ACTIVATOR_BUILD; then
    get_num_build
    local S_NUM_BUILD=$?
    if [ $S_NUM_BUILD -eq 0 ]; then
      client_result "Application is building. $WAIT_MESSAGE"
    else
      client_result "Application is building"
    fi
  elif is_running $PLAY2_PID_RUN; then
    client_result "Application is running"
  else
    client_result "Application is either stopped or inaccessible"
  fi
}


# Kill the process given by $1 and its children
kill_tree() {
  local KT_PARENT_PID=$1
  for KT_PID_CHILD in $(ps -o pid --no-headers --ppid ${KT_PARENT_PID});
  do
    kill_tree ${KT_PID_CHILD}
  done

  local KT_SHOULD_BE_GONE_ID=$(ps -o pid -p ${KT_PARENT_PID} --no-headers)
  if [ -z "$KT_SHOULD_BE_GONE_ID" ]; then
    return
  else
    kill -TERM ${KT_PARENT_PID}
  fi

  local KT_COUNT=0
  while [ ${KT_COUNT} -lt 15 ]
  do
    local KT_SHOULD_BE_GONE_ID=$(ps -o pid -p ${KT_PARENT_PID} --no-headers)
    if [ -z "$KT_SHOULD_BE_GONE_ID" ]; then
      return
    else
      sleep 2
      let KT_COUNT=${KT_COUNT}+1
    fi
  done

  local KT_SHOULD_BE_GONE_ID=$(ps -o pid -p ${KT_PARENT_PID} --no-headers)
  if [ ! -z $KT_SHOULD_BE_GONE_ID ]; then
    kill -9 ${KT_PARENT_PID}
  fi
}

function catchall {
  echo "$1 - Not yet implemented"
}


case "$1" in
  start)       start ;;
  stop)        stop ;;
  restart)     restart ;;
  status)      status ;;
  reload)      catchall "reload";;
  tidy)        tidy ;;
  pre-build)   catchall "pre-build";;
  build)       build ;;
  deploy)      catchall "deploy" ;;
  post-deploy) catchall "post-deploy";;
  *)           exit 0
esac

exit 0
